name: Build DEB Package

on:
  release:
    types: [created]

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y devscripts debhelper fakeroot

      - name: Prepare package structure
        run: |
          mkdir -p package/usr/local/bin
          mkdir -p package/usr/share/applications
          mkdir -p package/usr/share/icons/hicolor/scalable/apps
          mkdir -p package/DEBIAN

          # Copy files
          cp src/mint-cleaner.sh package/usr/local/bin/mint-cleaner
          cp desktop/mint-cleaner.desktop package/usr/share/applications/mint-cleaner.desktop
          cp icons/system-cleaner.svg package/usr/share/icons/hicolor/scalable/apps/system-cleaner.svg
          cp debian/postinst package/DEBIAN/postinst
          cp debian/prerm package/DEBIAN/prerm

          # Set permissions
          chmod 755 package/DEBIAN/postinst
          chmod 755 package/DEBIAN/prerm

      - name: Create DEBIAN control file
        run: |
          cat <<EOF > package/DEBIAN/control
          Package: linux-mint-cleaner
          Version: ${{ github.event.release.tag_name }}
          Section: utils
          Priority: optional
          Architecture: all
          Maintainer: skyss0fly <skyss0flypersonal@gmail.com>
          Description: Linux Mint Cleaner - Clean caches, Flatpak leftovers, Trash, and Timeshift snapshots
          EOF

      - name: Build DEB package
        run: dpkg-deb --build package

      - name: Upload DEB to GitHub Release
        uses: actions/upload-release-asset@v2
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: package.deb
          asset_name: linux-mint-cleaner.deb
          asset_content_type: application/vnd.debian.binary-package
